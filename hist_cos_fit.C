//==============================================================
//   hist_cos_fit.C   —  рисует hCos и фитирует N·(1+α cos²θ)
//   usage:  root -l -q hist_cos_fit.C
//==============================================================
void hist_cos_fit(const char* fname = "tauPolar.root")
{
    //----------------------------------------------------------
    // открываем файл и гистограмму
    //----------------------------------------------------------
    TFile f(fname,"READ");
    TH1D* h = dynamic_cast<TH1D*>(f.Get<TH1D>("hCos"));
    if(!h){ std::cerr<<"hCos not found in "<<fname<<"\n"; return; }

    //----------------------------------------------------------
    // глобальные опции: показать имя + Entr/Mean/RMS и параметры фита
    //----------------------------------------------------------
    gStyle->SetOptStat(1111);   // 1: Name, 1: Entries, 1: Mean, 1: RMS
    gStyle->SetOptFit (1111);   // χ²/ndf, Prob, p0, p1

    //----------------------------------------------------------
    // Canvas и гистограмма
    //----------------------------------------------------------
    TCanvas* c = new TCanvas("cCos","cos#theta",700,500);

    h->SetMinimum(0);
    h->SetLineWidth(2);
    h->Draw("HIST");            // ступеньками

    //----------------------------------------------------------
    // функция фита  N·(1 + α x²)
    //----------------------------------------------------------
    TF1* f1 = new TF1("f1","[0]*(1 + [1]*x*x)",-1.,1.);
    f1->SetParameter(0,h->Integral());   // N
    f1->SetParameter(1,1.0);             // α старт = 1
    f1->SetLineColor(kRed);
    f1->SetLineWidth(2);

    //----------------------------------------------------------
    // фит (R – диапазон функции; 0 – НЕ перерисовывать гисту)
    //----------------------------------------------------------
    h->Fit(f1,"R0");
    f1->Draw("same");
    gPad->Update();                       // stats-окно появилось

    //----------------------------------------------------------
    // подвинем stats-блок, чтобы не закрывал кривую
    //----------------------------------------------------------
    if(auto st = (TPaveStats*)h->FindObject("stats")){
        st->SetX1NDC(0.62); st->SetX2NDC(0.88);
        st->SetY1NDC(0.68); st->SetY2NDC(0.88);
    }
    gPad->Modified();
    gPad->Update();
    if (auto st = (TPaveStats*)gPad->FindObject("stats")) {
        st->SetX1NDC(0.15);
        st->SetX2NDC(0.45);
        st->SetY1NDC(0.65);
        st->SetY2NDC(0.90);
        gPad->Modified();
        gPad->Update();
    }
    //----------------------------------------------------------
    // вывод чисел в консоль
    //----------------------------------------------------------
    std::cout << "\n=== Fit result =================================\n"
              << "  N        = " << f1->GetParameter(0)
              << "  ± "         << f1->GetParError(0) << '\n'
              << "  alpha    = " << f1->GetParameter(1)
              << "  ± "         << f1->GetParError(1) << '\n'
              << "  chi2/ndf = " << f1->GetChisquare()/f1->GetNDF()
              << " / "          << f1->GetNDF()       << '\n'
              << "  Prob     = " << f1->GetProb()      << '\n'
              << "===============================================\n";

    //----------------------------------------------------------
    // сохраняем картинку
    //----------------------------------------------------------
    c->SaveAs("fig_cosTheta_fit.pdf");
}
//==============================================================
